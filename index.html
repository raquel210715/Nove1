<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calendari d’Hàbits</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Open+Sans&display=swap" rel="stylesheet">
<style>
body {margin:0;font-family:'Open Sans',sans-serif;color:#333;background:#fdfcfb;position:relative;overflow-x:hidden;}
body::before,body::after {content:"";position:absolute;background-repeat:no-repeat;background-size:contain;z-index:0;opacity:0.1;pointer-events:none;}
body::before {top:0;left:0;width:200px;height:200px;background-image:url('https://upload.wikimedia.org/wikipedia/commons/thumb/5/52/Leaf_icon.svg/256px-Leaf_icon.svg.png');}
body::after {bottom:0;right:0;width:250px;height:250px;background-image:url('https://upload.wikimedia.org/wikipedia/commons/thumb/5/52/Leaf_icon.svg/256px-Leaf_icon.svg.png');transform:rotate(180deg);}
header{text-align:center;padding:2rem 1rem 0.5rem;position:relative;z-index:1;}
header h1{font-family:'Playfair Display',serif;font-size:2.5rem;margin:0;color:#222;}
.calendar-wrapper{max-width:1000px;margin:0 auto;padding:1rem;position:relative;z-index:1;}
.month-nav{display:flex;justify-content:center;align-items:center;gap:20px;margin-bottom:1rem;}
.month-nav button{background:none;border:none;font-size:2rem;cursor:pointer;color:#666;}
.day-names,.calendar{display:grid;grid-template-columns:repeat(7,1fr);}
.day-names div{background:#f5f5f5;text-align:center;padding:0.5rem;font-weight:bold;font-size:0.85rem;}
.calendar .day{background:#fff;border:1px solid #eee;min-height:90px;padding:6px;position:relative;cursor:pointer;box-sizing:border-box;transition:transform 0.2s;}
.calendar .day:hover{transform:scale(1.03);}
.day-number{font-weight:bold;font-size:0.9rem;}
.circles{position:absolute;bottom:6px;left:50%;transform:translateX(-50%);display:flex;gap:4px;flex-wrap:wrap;justify-content:center;}
.circle{width:10px;height:10px;border-radius:50%;border:2px solid;cursor:pointer;}
.circle.done{background-color:currentColor;}
.modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:999;padding:1rem;display:none;}
.modal-content{background:white;padding:1.5rem;border-radius:10px;width:100%;max-width:400px;position:relative;box-shadow:0 4px 12px rgba(0,0,0,0.2);}
.close-btn{position:absolute;top:10px;right:10px;background:#eee;border:none;border-radius:50%;width:30px;height:30px;font-size:16px;cursor:pointer;}
.habit-label{display:flex;align-items:center;margin:0.8rem 0;font-size:0.95rem;}
.habit-label .circle{margin-right:10px;cursor:pointer;}
.button-row{display:flex;justify-content:center;gap:20px;margin:1rem 0;}
.action-btn{width:80px;height:80px;background:#eee;border-radius:15px;display:flex;justify-content:center;align-items:center;font-size:1.5rem;cursor:pointer;}
#restart-btn{position:fixed;bottom:20px;right:20px;width:50px;height:50px;background:#ddd;border-radius:50%;display:flex;justify-content:center;align-items:center;font-size:1.5rem;cursor:pointer;z-index:1000;}
#send-summary-btn{position:fixed;bottom:20px;left:20px;width:50px;height:50px;background:#ddd;border-radius:50%;display:flex;justify-content:center;align-items:center;font-size:1.5rem;cursor:pointer;z-index:1000;}
@media(max-width:600px){header h1{font-size:2rem;}.calendar .day{min-height:70px;padding:4px;}.day-number{font-size:0.8rem;}.circle{width:8px;height:8px;}.habit-label{font-size:0.85rem;}}
</style>
</head>
<body>
<header><h1 id="month-year"></h1></header>
<div class="calendar-wrapper">
  <div class="month-nav"><button id="prev-month">&#8592;</button><div id="month-name"></div><button id="next-month">&#8594;</button></div>
  <div class="day-names">
    <div>Dill</div><div>Dll</div><div>Dm</div><div>Dc</div><div>Dj</div><div>Dv</div><div>Ds</div>
  </div>
  <div class="calendar" id="calendar"></div>
</div>

<div class="modal" id="day-modal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeModal()">X</button>
    <div id="habit-container"></div>
  </div>
</div>

<div id="restart-btn" title="Reinicia codi i email" onclick="resetUserData()">🔄</div>
<div id="send-summary-btn" title="Envia resum setmanal">📩</div>

<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script>
// Inicialitzar EmailJS
emailjs.init("Ii-pS-x9zkGqnawB7");
const serviceID = "service_ae4etn7";
const templateID = "template_88plg5s";

// Hàbits
const habits = [
  {color:'#f5ea16',text:'Exercici'},
  {color:'#119a48',text:'Prendre medicació'},
  {color:'#3954a3',text:'Menjar 5 fruites o verdures'},
  {color:'#c5278e',text:'Caminar 8000 passes'}
];

// User data
let userData = JSON.parse(localStorage.getItem('userData')) || null;
if(!userData || !userData.code || !userData.email){
  let code = prompt("Introdueix codi de 4 xifres:");
  let email = prompt("Introdueix email:");
  userData = {code,email};
  localStorage.setItem('userData',JSON.stringify(userData));
}

// Guardat hàbits
let habitData = JSON.parse(localStorage.getItem('habitData'))||{};

// Dates
let today = new Date();
let currentMonth = today.getMonth();
let currentYear = today.getFullYear();

// Calendar
function renderCalendar(){
  const calendar = document.getElementById('calendar');
  calendar.innerHTML='';
  let firstDay = new Date(currentYear,currentMonth,1).getDay();
  let daysInMonth = new Date(currentYear,currentMonth+1,0).getDate();
  for(let i=0;i<firstDay;i++){calendar.innerHTML+='<div></div>';}
  for(let d=1;d<=daysInMonth;d++){
    let dayDiv=document.createElement('div');dayDiv.className='day';
    dayDiv.innerHTML=`<div class="day-number">${d}</div><div class="circles"></div>`;
    dayDiv.onclick=()=>openModal(`${currentYear}-${currentMonth+1}-${d}`);
    calendar.appendChild(dayDiv);
    renderCircles(dayDiv,`${currentYear}-${currentMonth+1}-${d}`);
  }
  document.getElementById('month-name').textContent=`${monthNames(currentMonth)} ${currentYear}`;
}

function renderCircles(dayDiv,key){
  const circlesDiv = dayDiv.querySelector('.circles');
  circlesDiv.innerHTML='';
  habits.forEach((h,i)=>{
    const span = document.createElement('span');
    span.className='circle'; span.style.color=h.color;
    if(habitData[key]?.[i]) span.classList.add('done');
    span.onclick=(e)=>{e.stopPropagation(); toggleHabit(key,i,span);}
    circlesDiv.appendChild(span);
  });
}

function toggleHabit(key,index,el){
  habitData[key] = habitData[key]||Array(habits.length).fill(false);
  habitData[key][index] = !habitData[key][index];
  localStorage.setItem('habitData',JSON.stringify(habitData));
  if(el){if(habitData[key][index]) el.classList.add('done'); else el.classList.remove('done');}
}

// Popup
function openModal(key){
  const container = document.getElementById('habit-container'); container.innerHTML='';
  habits.forEach((h,i)=>{
    let div=document.createElement('div'); div.className='habit-label';
    let c = document.createElement('span'); c.className='circle'; c.style.color=h.color;
    if(habitData[key]?.[i]) c.classList.add('done');
    c.onclick=(e)=>{e.stopPropagation(); toggleHabit(key,i,c);}
    div.appendChild(c); div.appendChild(document.createTextNode(h.text));
    container.appendChild(div);
  });
  document.getElementById('day-modal').style.display='flex';
}
function closeModal(){document.getElementById('day-modal').style.display='none';}

function monthNames(m){return["GENER","FEBRER","MARÇ","ABRIL","MAIG","JUNY","JULIOL","AGOST","SETEMBRE","OCTUBRE","NOVEMBRE","DESEMBRE"][m];}

document.getElementById('prev-month').onclick=()=>{
  currentMonth--; if(currentMonth<0){currentMonth=11;currentYear--;}
  renderCalendar();
};
document.getElementById('next-month').onclick=()=>{
  currentMonth++; if(currentMonth>11){currentMonth=0;currentYear++;}
  renderCalendar();
};

renderCalendar();

// Botons TA i Exercici
function createActionButtons(){
  const wrapper = document.createElement('div'); wrapper.className='button-row';
  let taBtn=document.createElement('div'); taBtn.className='action-btn'; taBtn.textContent='TA'; taBtn.onclick=()=>openTAPopup();
  let exBtn=document.createElement('div'); exBtn.className='action-btn'; exBtn.textContent='Ex'; exBtn.onclick=()=>openPDF();
  wrapper.appendChild(taBtn); wrapper.appendChild(exBtn);
  document.body.appendChild(wrapper);
}
createActionButtons();

// TA
function openTAPopup(){
  const modal = document.getElementById('day-modal'); modal.style.display='flex';
  const container = document.getElementById('habit-container'); container.innerHTML='';
  const pencil = document.createElement('button'); pencil.textContent='✏️'; pencil.onclick=()=>{openTAPencil();};
  const cam = document.createElement('button'); cam.textContent='📷'; cam.onclick=()=>{openCamera();};
  container.appendChild(pencil); container.appendChild(cam);
}
function openTAPencil(){
  const container = document.getElementById('habit-container'); container.innerHTML='';
  for(let i=0;i<3;i++){let input=document.createElement('input'); input.type='number'; input.placeholder='000'; input.maxLength=3; input.style.display='block'; input.style.margin='5px 0'; container.appendChild(input);}
  let saveBtn=document.createElement('button'); saveBtn.textContent='💾'; saveBtn.onclick=()=>{alert('Guardat'); closeModal();}
  container.appendChild(saveBtn);
}
function openCamera(){
  const input = document.createElement('input'); input.type='file'; input.accept='image/*'; input.capture='camera';
  input.onchange=(e)=>{alert('Foto registrada'); closeModal();}
  input.click();
}

// PDF
function openPDF(){
  const day = new Date().getDay();
  let file='';
  if(day==1||day==6) file='pdf-propioceptiu.pdf';
  else if(day==4||day==0) file='pdf-forca.pdf';
  else file='pdf-extra.pdf';
  window.open(file,'_blank');
}

// Botó reinici
function resetUserData(){localStorage.removeItem('userData'); location.reload();}

// EmailJS resum setmanal
function getWeeklyData(){
  const today = new Date();
  let keys = Object.keys(habitData).filter(k=>new Date(k)<=today);
  let summary = {};
  keys.forEach(k=>{summary[k]=habitData[k];});
  return summary;
}

document.getElementById('send-summary-btn').onclick=()=>{
  const summary = getWeeklyData();
  emailjs.send(serviceID,templateID,{
    user_email: userData.email,
    code: userData.code,
    summary: JSON.stringify(summary)
  }).then(()=>alert('Resum enviat!'), err=>alert('Error enviant'));
}
</script>
</body>
</html>
